app-id: io.github.DamnedAngel.msx-tile-forge
runtime: org.freedesktop.Platform
runtime-version: "25.08"
sdk: org.freedesktop.Sdk

command: msxtileforge

finish-args:
  - --share=ipc # needed for X11
  - --socket=fallback-x11
  - --socket=wayland
  - --share=network
  - --socket=pulseaudio
  - --device=dri
  - --filesystem=xdg-documents

modules:
  - name: tcl
    sources:
      - type: archive
        url: https://downloads.sourceforge.net/tcl/tcl8.6.13-src.tar.gz
        sha256: 43a1fae7412f61ff11de2cfd05d28cfc3a73762f354a417c62370a54e2caf066
    buildsystem: autotools
    build-options:
      no-debuginfo: true
      strip: false
    cleanup:
      - /share/man

  - name: tk
    sources:
      - type: archive
        url: https://downloads.sourceforge.net/tcl/tk8.6.13-src.tar.gz
        sha256: 2e65fa069a23365440a3c56c556b8673b5e32a283800d8d9b257e3f584ce0675
    buildsystem: autotools
    build-options:
      no-debuginfo: true
      strip: false
    cleanup:
      - /share/man

  - name: python-deps
    buildsystem: simple
    build-commands:
      - pip3 install --no-index --find-links="file://${PWD}/wheels" --prefix=${FLATPAK_DEST} Pillow numpy scipy platformdirs tqdm
    sources:
      # Pillow
      - type: file
        url: https://files.pythonhosted.org/packages/3e/2a/xxx/Pillow-10.4.0-cp311-cp311-manylinux_2_28_x86_64.whl
        sha256: <sha256sum-for-pillow>
      # numpy
      - type: file
        url: https://files.pythonhosted.org/packages/41/9a/xxx/numpy-1.26.4-cp311-cp311-manylinux_2_28_x86_64.whl
        sha256: <sha256sum-for-numpy>
      # scipy
      - type: file
        url: https://files.pythonhosted.org/packages/97/5b/xxx/scipy-1.14.1-cp311-cp311-manylinux_2_28_x86_64.whl
        sha256: <sha256sum-for-scipy>
      # platformdirs
      - type: file
        url: https://files.pythonhosted.org/packages/1a/f9/xxx/platformdirs-4.3.6-py3-none-any.whl
        sha256: <sha256sum-for-platformdirs>
      # tqdm
      - type: file
        url: https://files.pythonhosted.org/packages/25/ce/xxx/tqdm-4.66.5-py3-none-any.whl
        sha256: <sha256sum-for-tqdm>

  - name: msx-tile-forge
    buildsystem: simple
    sources:
      - type: git
        url: https://github.com/DamnedAngel/msx-tile-forge.git
        tag: v01.00.00_rc20_5 # NOTE: tag name
        commit: 9d5ee12897f7cff657c396c8afe05dec1465beaf # NOTE: exact commit for the tag
      - type: file
        path: io.github.DamnedAngel.msx-tile-forge.desktop
      - type: file
        path: io.github.DamnedAngel.msx-tile-forge.metainfo.xml
      - type: file
        path: io.github.DamnedAngel.msx-tile-forge.png
      - type: file
        path: wrapper.sh
    build-commands:
      # NOTE: fix version string
      - find . -type f -name "*.py" -exec sed -i "s/<unreleased>/01.00.00_rc20_5/g" {} +
      # Install Python sources
      - install -Dm644 msxtileforge.py /app/bin/msxtileforge.py
      - install -Dm644 msxtileexport.py /app/bin/msxtileexport.py
      - install -Dm644 msxtilemagic.py /app/bin/msxtilemagic.py
      - install -Dm644 supertilerandomizer.py /app/bin/supertilerandomizer.py
      - install -Dm644 tilerandomizer.py /app/bin/tilerandomizer.py
      # Install wrapper script
      - install -Dm755 wrapper.sh /app/bin/msxtileforge
      # Install icon
      - install -Dm644 io.github.DamnedAngel.msx-tile-forge.png /app/share/icons/hicolor/256x256/apps/io.github.DamnedAngel.msx-tile-forge.png
      # Install desktop entry
      - install -Dm644 io.github.DamnedAngel.msx-tile-forge.desktop /app/share/applications/io.github.DamnedAngel.msx-tile-forge.desktop
      # Install AppStream metadata
      - install -Dm644 io.github.DamnedAngel.msx-tile-forge.metainfo.xml /app/share/metainfo/${FLATPAK_ID}.metainfo.xml
    cleanup:
      - "*.pyc"
      - "*.pyo"
